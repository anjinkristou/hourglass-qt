<form>
  <div id="activity-popup" class="ui-widget ui-widget-content ui-corner-all" style="padding: 0.5em; font-size: 1em; overflow: auto;">
    <div id="time-slider">
      <div class="labels">
        <div class="day-start">{{dayStartTime}}</div>
        <div class="duration"></div>
        <div class="day-end">{{dayEndTime}}</div>
        <div class="clear"></div>
      </div>
      <div class="slider"></div>
    </div>
    {{#activity}}
    <table>
      <tbody>
        <tr>
          <td>Time:</td>
          <td>
            <div class="no-wrap">
              <input class="activity-started-at-date" type="text" name="activity[started_at_mdy]" value="{{startedAtMDY}}" size="10" maxlength="10" />
              <input class="activity-started-at-time" type="text" name="activity[started_at_hm]" value="{{startedAtHM}}" size="5" maxlength="5" />
              to
            </div>
            <div class="no-wrap">
            {{#running}}
              <input class="activity-ended-at-time" type="text" name="activity[ended_at_hm]" value="{{endedAtHM}}" size="5" maxlength="5" disabled="disabled" />
              <input class="activity-ended-at-date" type="text" name="activity[ended_at_mdy]" value="{{endedAtMDY}}" size="10" maxlength="10" disabled="disabled" />
            {{/running}}
            {{#notRunning}}
              <input class="activity-ended-at-time" type="text" name="activity[ended_at_hm]" value="{{endedAtHM}}" size="5" maxlength="5" />
              <input class="activity-ended-at-date" type="text" name="activity[ended_at_mdy]" value="{{endedAtMDY}}" size="10" maxlength="10" />
            {{/notRunning}}
            </div>
            <div class="no-wrap">
            {{#running}}
              <input id="in-progress-checkbox" class="activity-running" type="checkbox" name="activity[running]" value="true" checked="checked" />
            {{/running}}
            {{#notRunning}}
              <input id="in-progress-checkbox" class="activity-running" type="checkbox" name="activity[running]" value="true" />
            {{/notRunning}}
              <label for="in-progress-checkbox">in progress</label>
            </div>
          </td>
        </tr>
        <tr>
          <td>Activity:</td>
          <td colspan="2"><input class="activity-name" type="text" name="activity[name_with_project]" value="{{nameWithProject}}" /></td>
        </tr>
        <tr>
          <td>Tags:</td>
          <td colspan="2"><input class="activity-tags" type="text" name="activity[tag_names]" value="{{tagNames}}" /></td>
        </tr>
      </tbody>
    </table>
    {{/activity}}
    <div class="ac-placeholder">&nbsp;</div>
  </div>
  <div class="right-align" style="margin: 0.5em 0";>
    <input id="save-button" type="submit" value="Save" />
    <input id="cancel-button" type="button" value="Cancel" />
  </div>
</form>
<script type="text/javascript">
  var dayStartTime = "{{dayStartTime}}";
  var dayEndTime = "{{dayEndTime}}";

  function dayStart() {
    return new Date($(".activity-started-at-date").val() + " " + dayStartTime);
  }
  function dayEnd() {
    return new Date($(".activity-started-at-date").val() + " " + dayEndTime);
  }
  function dateToYMD(d) {
    var month = d.getMonth() + 1;
    var day = d.getDate();
    return "" + (month < 10 ? "0" + month : month) + "/" + (day < 10 ? "0" + day : day) + "/" + d.getFullYear();
  }
  function dateToHM(d) {
    var hours = d.getHours();
    var minutes = d.getMinutes();
    return "" + (hours < 10 ? "0" + hours : hours) + ":" + (minutes < 10 ? "0" + minutes : minutes);
  }
  function startedAt() {
    return new Date($(".activity-started-at-date").val() + " " + $(".activity-started-at-time").val());
  }
  function setStartedAt(minutes) {
    var d = new Date(minutes * 60000);
    $('.activity-started-at-date').val(dateToYMD(d));
    $('.activity-started-at-time').val(dateToHM(d));
  }
  function endedAt() {
    return new Date($(".activity-ended-at-date").val() + " " + $(".activity-ended-at-time").val());
  }
  function setEndedAt(minutes) {
    var d = new Date(minutes * 60000);
    $('.activity-ended-at-date').val(dateToYMD(d));
    $('.activity-ended-at-time').val(dateToHM(d));
  }

  $(function() {
    var form = $('form');

    $('#save-button, #cancel-button').button();

    var checkbox = $('#in-progress-checkbox');
    checkbox.click(function(e) {
      if (checkbox.is(':checked')) {
        form.find('.activity-ended-at-time').attr('disabled', true);
        form.find('.activity-ended-at-date').attr('disabled', true);
      }
      else {
        form.find('.activity-ended-at-time').attr('disabled', false);
        form.find('.activity-ended-at-date').attr('disabled', false);
      }
    });

    var submitUrl = "{{submitUrl}}";
    form.submit(function(e) {
      e.preventDefault();
      $.post(submitUrl, form.serialize(), function(data, status) {
        if (data && !data.errors) {
          window.opener.updateUI(data);
          window.close();
        }
        else {
          // TODO: show reason for failure
        }
      }, 'json');
    });

    $('#cancel-button').click(function(e) {
      e.preventDefault();
      window.close();
    });

    var timeValues = [ startedAt().getTime() / 60000, endedAt().getTime() / 60000 ];
    $('#time-slider .slider').slider({
      range: true,
      min: dayStart().getTime() / 60000,
      max: dayEnd().getTime() / 60000,
      values: timeValues,
      slide: function(event, ui) {
        var duration = millisecondsToWords((ui.values[1] - ui.values[0]) * 60000);
        $("#time-slider .duration").html(duration);
        setStartedAt(ui.values[0]);
        setEndedAt(ui.values[1]);
      }
    });
    $("#time-slider .duration").html(millisecondsToWords((timeValues[1] - timeValues[0]) * 60000));
  });
</script>
