#ifndef SERVER_H
#define SERVER_H

#define PUBLIC_PATH "@hourglass_PUBLIC_PATH@"

#include <QObject>
#include <QString>
#include <QRegExp>
#include <QSqlDatabase>
#include <QList>
#include <QPair>
#include "mongoose.h"
#include "activity.h"

class Server : public QObject
{
  Q_OBJECT

  public:
    Server(QString port, QObject *parent = 0);
    void start();

    static const QRegExp activityPath;
    static const QRegExp editActivityPath;
    static const QRegExp deleteActivityPath;
    static const QRegExp restartActivityPath;
    static QList<QPair<QString, QString> > decodePost(const char *data);
    static QString &toJSON(QString &str);

  signals:
    void started();
    void stopped();

  public slots:
    void stop();

  private:
    struct mg_context *ctx;
    QString port;

    static void *route(enum mg_event event, struct mg_connection *conn, const struct mg_request_info *request_info);

    QString partialActivities(QList<Activity> activities);
    QString partialCurrent();
    QString partialToday();
    QString partialWeek();
    QString partialTotals();
    QString partialUpdates();
    QString partialActivityNames();
    QString partialProjectNames();
    QString partialTagNames();

    QString index();
    QString createActivity(const QList<QPair<QString, QString> > &params);
    QString stopCurrentActivities();
    QString newActivity();
};

#endif
